<!DOCTYPE html>
<!--
  è¡Œæ”¿æ©Ÿé—œè¾¦å…¬æ—¥æ›†è¡¨ - æœˆæ›†ç‰ˆé¦–é  (index.html)
  åŠŸèƒ½ï¼š
  1. æä¾›é¡ä¼¼ Google Calendar çš„æœˆæ›†è¦–åœ–ã€‚
  2. æ•´åˆã€Œç¤¾ç•œå„€è¡¨æ¿ã€ï¼Œé¡¯ç¤ºé€£å‡å€’æ•¸ã€å¹´åº¦é€²åº¦èˆ‡å³æ™‚åœç­åœèª²è³‡è¨Šã€‚
  3. æ”¯æ´å¹´ä»½åˆ‡æ›èˆ‡è©³ç´°/ç²¾ç°¡ç‰ˆé€£çµã€‚
-->
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <title>è¡Œæ”¿æ©Ÿé—œè¾¦å…¬æ—¥æ›†è¡¨</title>
    <!-- 
      æ¨£å¼å®šç¾©å€ 
      å®šç¾©äº†å…¨ç«™ä¸»é¡Œé¡è‰² (CSS Variables) èˆ‡å„å€å¡Šæ¨£å¼ã€‚
      åŒ…å«æœˆæ›†ç¶²æ ¼ (Grid Layout)ã€Dashboard å¡ç‰‡èˆ‡éŸ¿æ‡‰å¼è¨­è¨ˆã€‚
    -->
    <style>
      :root {
        /* ä¸»é¡Œè‰²ç³»å®šç¾© */
        --primary: #1a73e8;
        --primary-light: #e8f0fe;
        --holiday: #c62828;
        --holiday-bg: #ffebee;
        --workday: #2e7d32;
        --workday-bg: #e8f5e9;
        --border: #e0e0e0;
        --text: #424242;
        --text-light: #757575;
        --weekend: #fafafa;
        --weekend-tag: #78909c;
        --weekend-tag-bg: #eceff1;
        --adjusted: #6a1b9a;
        --adjusted-bg: #f3e5f5;
        --special: #ef6c00;
        --special-bg: #fff3e0;
        --today: #1565c0;
        --today-bg: #e3f2fd;
      }
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: 'Google Sans', 'Segoe UI', Arial, sans-serif;
        background: #fff;
        color: var(--text);
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 16px;
      }
      /* é é¦–æ¨™é¡Œèˆ‡å°èˆª */
      .header {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 16px;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border);
      }
      .header h1 {
        font-size: 22px;
        font-weight: 400;
        color: var(--text);
        flex: 1;
      }
      .header h1 span {
        font-size: 14px;
        color: var(--primary);
        background: var(--primary-light);
        padding: 4px 10px;
        border-radius: 12px;
        margin-left: 8px;
      }
      /* æ§åˆ¶æŒ‰éˆ•å€ (ä¸Šä¸‹æœˆåˆ‡æ›) */
      .controls {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
      }
      .nav-btn {
        background: none;
        border: 1px solid var(--border);
        border-radius: 4px;
        padding: 8px 16px;
        cursor: pointer;
        font-size: 14px;
        color: var(--text);
        transition: background 0.2s;
      }
      .nav-btn:hover {
        background: var(--weekend);
      }
      .nav-btn.primary {
        background: var(--primary);
        color: #fff;
        border-color: var(--primary);
      }
      .nav-btn.primary:hover {
        background: #1557b0;
      }
      select {
        padding: 8px 12px;
        border: 1px solid var(--border);
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
        background: #fff;
      }
      /* å³ä¸Šè§’åˆ‡æ›é€£çµ */
      .nav-links {
        display: flex;
        gap: 8px;
        margin-left: auto;
      }
      .nav-link {
        text-decoration: none;
        color: var(--primary);
        font-size: 14px;
        padding: 8px 12px;
        border-radius: 4px;
        transition: background 0.2s;
      }
      .nav-link:hover {
        background: var(--primary-light);
      }
      /* æœˆæ›†ä¸»é«” */
      .calendar {
        border: 1px solid var(--border);
        border-radius: 8px;
        overflow: hidden;
      }
      .calendar-header {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        background: var(--weekend);
        border-bottom: 1px solid var(--border);
      }
      .calendar-header div {
        padding: 12px;
        text-align: center;
        font-size: 14px;
        font-weight: 500;
        color: var(--text-light);
        text-transform: uppercase;
      }
      .calendar-header div:first-child,
      .calendar-header div:last-child {
        color: var(--holiday);
      }
      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        height: auto; /* æ”¹ç‚ºè‡ªå‹•é«˜åº¦ï¼Œç”±å…§å®¹æ’é–‹ä½†è¨­æœ€å°é«˜åº¦ */
        min-height: 480px;
      }
      .calendar-grid.weeks-5 {
        grid-template-rows: repeat(5, 1fr);
      }
      .calendar-grid.weeks-6 {
        grid-template-rows: repeat(6, 1fr);
      }
      .day-cell {
        border-right: 1px solid var(--border);
        border-bottom: 1px solid var(--border);
        padding: 4px;
        position: relative;
        cursor: default;
        overflow: hidden;
        min-height: 100px; /* è¨­å®šæœ€å°é«˜åº¦ */
      }
      .day-cell:nth-child(7n) {
        border-right: none;
      }
      .day-cell.other-month {
        background: #f5f5f5;
      }
      .day-cell.other-month .day-number {
        color: #ccc;
      }
      .day-cell.weekend {
        background: var(--weekend);
      }
      .day-cell.today .day-number {
        background: var(--today);
        color: #fff;
      }
      .day-number {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        font-size: 14px;
        font-weight: 500;
        border-radius: 50%;
        margin-bottom: 2px;
      }
      .day-events {
        font-size: 12px;
        line-height: 1.4;
      }
      .event {
        padding: 2px 4px;
        border-radius: 3px;
        margin-bottom: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      /* äº‹ä»¶é¡å‹æ¨£å¼ */
      .event.holiday {
        background: var(--holiday-bg);
        color: var(--holiday);
      }
      .event.workday {
        background: var(--workday-bg);
        color: var(--workday);
      }
      .event.weekend {
        background: transparent;
        color: #9e9e9e;
        font-weight: 400;
      }
      .event.weekend-special {
        background: var(--special-bg);
        color: var(--special);
        border: 1px dashed var(--special);
        font-weight: 500;
      }
      .event.adjusted {
        background: var(--adjusted-bg);
        color: var(--adjusted);
      }
      .event.special {
        background: var(--special-bg);
        color: var(--special);
      }
      /* åœ–ä¾‹èªªæ˜ */
      .legend {
        display: flex;
        gap: 16px;
        margin-top: 16px;
        padding: 12px;
        background: var(--weekend);
        border-radius: 8px;
        flex-wrap: wrap;
      }
      .legend-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        color: var(--text-light);
      }
      .legend-color {
        width: 12px;
        height: 12px;
        border-radius: 2px;
      }
      .footer {
        margin-top: 16px;
        text-align: center;
        font-size: 12px;
        color: var(--text-light);
      }
      .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 400px;
        color: var(--text-light);
      }
      /* Dashboard Styles (å„€è¡¨æ¿) */
      .dashboard {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 8px; /* 12px -> 8px */
        margin-bottom: 8px; /* 12px -> 8px */
        animation: fadeIn 0.5s ease-in;
      }
      .dashboard-card {
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 8px 12px; /* 12px -> 8px 12px */
        display: flex;
        align-items: center; /* æ”¹ç‚º center è®“å…§å®¹å‚ç›´ç½®ä¸­ */
        gap: 10px; /* 12px -> 10px */
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        transition: transform 0.2s;
        min-height: 60px; /* è¨­å®šä¸€å€‹è¼ƒå°çš„æœ€å°é«˜åº¦ */
      }
      .dashboard-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      .card-icon {
        font-size: 18px; /* 24px -> 18px */
        background: var(--weekend);
        width: 36px; /* 48px -> 36px */
        height: 36px; /* 48px -> 36px */
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        flex-shrink: 0; /* é˜²æ­¢ icon è¢«å£“ç¸® */
      }
      .card-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }
      .card-title {
        font-size: 11px; /* 14px -> 11px */
        color: var(--text-light);
        margin-bottom: 2px;
        font-weight: 500;
        line-height: 1;
      }
      .card-desc {
        font-size: 13px; /* 16px -> 13px */
        color: var(--text);
        font-weight: 600;
        line-height: 1.2;
      }
      .card-desc span.highlight {
        color: var(--primary);
        font-size: 15px; /* 20px -> 15px */
        margin: 0 2px;
      }
      .progress-container {
        height: 4px; /* 8px -> 4px */
        background: var(--weekend);
        border-radius: 2px;
        overflow: hidden;
        margin: 4px 0;
      }
      .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, var(--primary), #4285f4);
        border-radius: 4px;
        transition: width 1s ease-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @media (max-width: 600px) {
        .dashboard {
          grid-template-columns: 1fr;
        }
      }
      @media (max-width: 768px) {
        .day-cell {
          min-height: 60px;
        }
        .day-number {
          width: 24px;
          height: 24px;
          font-size: 12px;
        }
        .header h1 {
          font-size: 18px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Dashboard Area (ç¤¾ç•œå„€è¡¨æ¿) -->
      <div class="dashboard" id="dashboard" style="display: none">
        <!-- å¡ç‰‡ 1: ä¸‹ä¸€å€‹é€£å‡å€’æ•¸ -->
        <div class="dashboard-card holiday-countdown">
          <div class="card-icon">ğŸ¯</div>
          <div class="card-content">
            <div class="card-title">ä¸‹ä¸€å€‹ç›®æ¨™</div>
            <div class="card-desc" id="nextHolidayContent">è¼‰å…¥ä¸­...</div>
          </div>
        </div>
        <!-- å¡ç‰‡ 2: å¹´åº¦é€²åº¦æ¢ -->
        <div class="dashboard-card year-progress">
          <div class="card-icon">â³</div>
          <div class="card-content">
            <div class="card-title" id="yearProgressTitle">2025å¹´ é€²åº¦æ¢</div>
            <div class="progress-container">
              <div
                class="progress-bar"
                id="yearProgressBar"
                style="width: 0%"
              ></div>
            </div>
            <div
              class="card-desc"
              id="yearProgressDesc"
              style="
                font-size: 12px;
                font-weight: normal;
                color: var(--text-light);
              "
            >
              ...
            </div>
          </div>
        </div>
        <!-- å¡ç‰‡ 3: é¢±é¢¨å‡æŸ¥è©¢ (é»æ“Šè§¸ç™¼) -->
        <div
          class="dashboard-card typhoon-check"
          style="cursor: pointer"
          onclick="checkTyphoonViaProxy()"
        >
          <div class="card-icon" style="background: #fff3e0; color: #ef6c00">
            ğŸŒ€
          </div>
          <div class="card-content">
            <div class="card-title">å³æ™‚åœç­åœèª²</div>
            <div class="card-desc" id="typhoonContent">
              <span style="font-size: 14px; color: var(--primary)"
                >é»æ“ŠæŸ¥è©¢å°åŒ—å¸‚ç‹€æ³</span
              >
            </div>
          </div>
        </div>
      </div>

      <!-- Header: æ¨™é¡Œèˆ‡å°èˆª -->
      <div class="header">
        <h1>ğŸ“… è¡Œæ”¿æ©Ÿé—œè¾¦å…¬æ—¥æ›†è¡¨<span>æœˆæ›†ç‰ˆ</span></h1>
        <div class="controls">
          <button class="nav-btn" id="prevMonth">â—€ ä¸Šæœˆ</button>
          <select id="yearSelect"></select>
          <select id="monthSelect"></select>
          <button class="nav-btn" id="nextMonth">ä¸‹æœˆ â–¶</button>
          <button class="nav-btn primary" id="todayBtn">ä»Šå¤©</button>
        </div>
        <div class="nav-links">
          <a href="simple.html" class="nav-link" id="linkSimple">ğŸ“‹ ç²¾ç°¡ç‰ˆ</a>
          <a href="detail.html" class="nav-link" id="linkDetail">ğŸ“Š è©³ç´°ç‰ˆ</a>
        </div>
      </div>
      
      <!-- Calendar Grid: æœˆæ›†ä¸»é«”å€ -->
      <div class="calendar">
        <div class="calendar-header">
          <div>æ—¥</div>
          <div>ä¸€</div>
          <div>äºŒ</div>
          <div>ä¸‰</div>
          <div>å››</div>
          <div>äº”</div>
          <div>å…­</div>
        </div>
        <div class="calendar-grid" id="calendarGrid">
          <div class="loading">è¼‰å…¥ä¸­...</div>
        </div>
      </div>

      <!-- Legend: åœ–ä¾‹èªªæ˜ -->
      <div class="legend">
        <div class="legend-item">
          <div
            class="legend-color"
            style="
              background: var(--holiday-bg);
              border: 1px solid var(--holiday);
            "
          ></div>
          åœ‹å®šå‡æ—¥
        </div>
        <div class="legend-item">
          <div
            class="legend-color"
            style="
              background: var(--adjusted-bg);
              border: 1px solid var(--adjusted);
            "
          ></div>
          èª¿æ•´æ”¾å‡
        </div>
        <div class="legend-item">
          <div
            class="legend-color"
            style="
              background: var(--workday-bg);
              border: 1px solid var(--workday);
            "
          ></div>
          è£œç­æ—¥
        </div>
        <div class="legend-item">
          <div
            class="legend-color"
            style="
              background: var(--special-bg);
              border: 1px solid var(--special);
            "
          ></div>
          ç‰¹æ®Šç¯€æ—¥
        </div>
        <div class="legend-item" style="margin-left: auto; font-size: 14px; color: var(--text);">
          è³‡æ–™ä¾†æºï¼š<a href="https://data.taipei/" target="_blank">è‡ºåŒ—å¸‚è³‡æ–™å¤§å¹³è‡º</a>
        </div>
      </div>
    </div>

    <!-- æ‡‰ç”¨ç¨‹å¼é‚è¼¯ -->
    <script>
      // è³‡æ–™è·¯å¾‘è¨­å®š
      const DATA_PATH = 'opendata/holiday';
      
      // DOM å…ƒç´ åƒè€ƒ
      const yearSelect = document.getElementById('yearSelect');
      const monthSelect = document.getElementById('monthSelect');
      const calendarGrid = document.getElementById('calendarGrid');
      
      // ç‹€æ…‹è®Šæ•¸
      let currentYear,
        currentMonth,
        holidayData = {}, // å¿«å–å·²è¼‰å…¥çš„å‡æ—¥è³‡æ–™
        availableYears = []; // å¯ç”¨çš„å¹´ä»½åˆ—è¡¨

      // åˆå§‹åŒ–æœˆä»½é¸å–® (1-12æœˆ)
      for (let m = 1; m <= 12; m++) {
        monthSelect.innerHTML += `<option value="${m}">${m}æœˆ</option>`;
      }

      /**
       * æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å‡½å¼
       * 1. å–å¾—ç¾åœ¨æ—¥æœŸ
       * 2. è¼‰å…¥ availableYears åˆ—è¡¨
       * 3. è¨­å®š UI åˆå§‹ç‹€æ…‹
       * 4. è¼‰å…¥æ‰€éœ€å¹´ä»½è³‡æ–™ä¸¦æ¸²æŸ“
       */
      async function init() {
        const today = new Date();
        currentYear = today.getFullYear();
        currentMonth = today.getMonth() + 1;
        try {
          // åŠ ä¸Šæ™‚é–“æˆ³è¨˜é¿å…å¿«å–
          const res = await fetch(`${DATA_PATH}/years.json?t=${new Date().getTime()}`);
          availableYears = await res.json();
          yearSelect.innerHTML = availableYears
            .map((y) => `<option value="${y}">${y}</option>`)
            .join('');

          // ç¢ºä¿è¼‰å…¥è³‡æ–™é‚è¼¯
          // 1. ç”¨æ–¼é¡¯ç¤ºæœˆæ›†çš„å¹´ä»½ (å¦‚æœç•¶å‰å¹´ä»½ä¸åœ¨è³‡æ–™åº«ï¼Œé è¨­é¡¯ç¤ºæœ€æ–°æˆ–æœ€èˆŠ)
          let calendarYear = currentYear;
          if (!availableYears.includes(String(calendarYear))) {
            calendarYear = parseInt(availableYears[0]);
          }

          // è¨­å®š UI
          yearSelect.value = calendarYear;
          monthSelect.value = currentMonth;

          // æ›´æ–°å…¨åŸŸè®Šæ•¸ä»¥ä¾› renderCalendar ä½¿ç”¨
          currentYear = calendarYear;
          updateLinks();

          // 2. è¼‰å…¥è³‡æ–™
          // è¼‰å…¥æœˆæ›†é¡¯ç¤ºå¹´ä»½
          await loadYear(currentYear);

          // è¼‰å…¥çœŸå¯¦ç•¶å‰å¹´ä»½èˆ‡æ˜å¹´ (ç‚ºäº† Dashboard è¨ˆç®—å€’æ•¸)
          const realYear = today.getFullYear();
          if (realYear !== currentYear) await loadYear(realYear);
          if (availableYears.includes(String(realYear + 1))) {
            await loadYear(realYear + 1);
          }

          renderCalendar();
          renderDashboard();
          document.getElementById('dashboard').style.display = 'grid';
        } catch (e) {
          calendarGrid.innerHTML = `<div class="loading">è¼‰å…¥å¤±æ•—: ${e.message}</div>`;
          console.error(e);
        }
      }

      /**
       * æ¸²æŸ“ Dashboard (ç¤¾ç•œå„€è¡¨æ¿)
       * è¨ˆç®—ä¸¦é¡¯ç¤ºä¸‹ä¸€å€‹é€£å‡èˆ‡å¹´åº¦é€²åº¦æ¢
       */
      function renderDashboard() {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        // æ ¼å¼åŒ–ç‚º YYYYMMDD
        const todayStr = `${today.getFullYear()}${String(
          today.getMonth() + 1
        ).padStart(2, '0')}${String(today.getDate()).padStart(2, '0')}`;

        // --- 1. ä¸‹ä¸€å€‹é€£å‡é‚è¼¯ ---
        let nextHoliday = null;
        // æœå°‹ä»Šå¹´å’Œæ˜å¹´
        const searchYears = [today.getFullYear(), today.getFullYear() + 1];

        // å°‹æ‰¾å€™é¸äºº
        for (const year of searchYears) {
          const data = holidayData[year];
          if (!data) continue;

          for (const h of data) {
            // éæ¿¾æ‰éå»çš„æ—¥æœŸ
            if (h.date < todayStr) continue;

            // å¿…é ˆæ˜¯æ”¾å‡æ—¥ (holiday: true)
            if (!h.holiday) continue;

            // éæ¿¾æ‰å–®ç´”çš„é€±æœ« (é™¤éæ˜¯ç‰¹åˆ¥æŒ‡å®šçš„ç¯€æ—¥)
            const category = (h.holidayCategory || '').trim();
            if (category === 'æ˜ŸæœŸå…­ã€æ˜ŸæœŸæ—¥') continue;

            // æ‰¾åˆ°ç¬¬ä¸€å€‹ç¬¦åˆçš„
            nextHoliday = h;
            break;
          }
          if (nextHoliday) break;
        }

        const holidayTitle = document.getElementById('nextHolidayContent');

        if (nextHoliday) {
          const targetDate = new Date(
            parseInt(nextHoliday.date.substring(0, 4)),
            parseInt(nextHoliday.date.substring(4, 6)) - 1,
            parseInt(nextHoliday.date.substring(6, 8))
          );

          const diffTime = targetDate - today;
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

          let desc = '';
          const name = nextHoliday.name || 'æ”¾å‡';

          if (diffDays <= 0) {
            desc = `æ­£åœ¨æ”¾å‡ä¸­ï¼<br>äº«å— <span class="highlight">${name}</span> å§ï¼`;
          } else {
            desc = `è·é›¢ <span class="highlight">${name}</span><br>é‚„æœ‰ <span class="highlight">${diffDays}</span> å¤©`;
          }
          holidayTitle.innerHTML = desc;
        } else {
          holidayTitle.innerHTML =
            'è³‡æ–™åº«ä¸­æš«ç„¡ä¸‹ä¸€å€‹å‡æœŸ...<br>å…ˆå°ˆå¿ƒå·¥ä½œå§ï¼';
        }

        // --- 2. å¹´åº¦é€²åº¦æ¢é‚è¼¯ ---
        const startOfYear = new Date(today.getFullYear(), 0, 1);
        const endOfYear = new Date(today.getFullYear() + 1, 0, 1);
        const totalMillis = endOfYear - startOfYear;
        const elapsedMillis = today - startOfYear; // ç¾åœ¨è·é›¢å¹´åˆéäº†å¤šä¹…
        let progress = (elapsedMillis / totalMillis) * 100;
        progress = Math.max(0, Math.min(100, progress)); // é™åˆ¶ 0-100

        document.getElementById(
          'yearProgressTitle'
        ).innerText = `${today.getFullYear()}å¹´ é€²åº¦æ¢`;
        document.getElementById('yearProgressBar').style.width = `${progress}%`;

        let progressText = '';
        if (progress < 15) progressText = 'æ–°çš„ä¸€å¹´ï¼Œè«‹å¤šæŒ‡æ•™';
        else if (progress < 40) progressText = 'åŠªåŠ›æ¬ç£šä¸­...';
        else if (progress < 60) progressText = 'ä»Šå¹´éä¸€åŠå›‰ï¼';
        else if (progress < 85) progressText = 'æ’ä½ï¼å¹´çµ‚åœ¨å‘ä½ æ‹›æ‰‹';
        else progressText = 'æœ€å¾Œè¡åˆºï¼';

        document.getElementById(
          'yearProgressDesc'
        ).innerText = `${progress.toFixed(1)}% - ${progressText}`;
      }

      /**
       * é€é Proxy æª¢æŸ¥ NCDR é¢±é¢¨å‡è³‡è¨Š (GitHub Pages é©ç”¨)
       * ä½¿ç”¨ allorigins.win ä½œç‚º CORS Proxy ç¹éç€è¦½å™¨é™åˆ¶ã€‚
       * 
       * æ³¨æ„ï¼šæ­¤æ–¹æ³•åƒ…ä¾›éœæ…‹ç¶²ç«™å±•ç¤ºç”¨ï¼Œæ­£å¼ç’°å¢ƒæ‡‰ä½¿ç”¨å¾Œç«¯ APIã€‚
       */
      async function checkTyphoonViaProxy() {
        const content = document.getElementById('typhoonContent');
        content.innerHTML =
          '<span style="font-size: 14px; color: var(--text-light);">æŸ¥è©¢ä¸­(Proxy)...</span>';

        const targetUrl =
          'https://alerts.ncdr.nat.gov.tw/JSONAtomFeed.ashx?AlertType=33';
        const proxyUrl =
          'https://api.allorigins.win/raw?url=' + encodeURIComponent(targetUrl);

        try {
          const res = await fetch(proxyUrl);
          if (!res.ok) throw new Error('Proxy Fetch Error');

          const rootData = await res.json();
          // NCDR åŸå§‹çµæ§‹é€šå¸¸æ˜¯ { entry: [...] } æˆ– { entry: {...} } (å–®ç­†æ™‚)
          // éœ€åšæ­£è¦åŒ–è™•ç†
          let entries = [];
          if (rootData && rootData.entry) {
            if (Array.isArray(rootData.entry)) {
              entries = rootData.entry;
            } else {
              entries = [rootData.entry];
            }
          }

          // å‰ç«¯é‡ç¾å¾Œç«¯éæ¿¾é‚è¼¯ï¼šé–å®šå°åŒ—å¸‚å…¨å€
          const targetCity1 = 'è‡ºåŒ—å¸‚';
          const targetCity2 = 'å°åŒ—å¸‚';

          const filtered = entries.filter((entry) => {
            if (!entry.summary || !entry.summary['#text']) return false;
            const text = entry.summary['#text'];

            // 1. æª¢æŸ¥æ˜¯å¦åŒ…å«ç›®æ¨™åŸå¸‚
            const hasCityName =
              text.includes(targetCity1) || text.includes(targetCity2);
            if (!hasCityName) return false;

            // 2. å…¨å€åˆ¤æ–·é‚è¼¯ (æª¢æŸ¥ "è‡ºåŒ—å¸‚:" æˆ– "è‡ºåŒ—å¸‚ï¼š")
            const isAllArea1 =
              text.includes(targetCity1 + ':') ||
              text.includes(targetCity1 + 'ï¼š');
            const isAllArea2 =
              text.includes(targetCity2 + ':') ||
              text.includes(targetCity2 + 'ï¼š');

            return isAllArea1 || isAllArea2;
          });

          if (filtered.length > 0) {
            // æœ‰è³‡æ–™ï¼Œé¡¯ç¤ºç¬¬ä¸€ç­†
            const summary = filtered[0].summary['#text'];
            let cleanText = summary
              .replace(/\[.*?\]/g, '')
              .replace(/è¡Œæ”¿é™¢äººäº‹è¡Œæ”¿ç¸½è™•.*/, '');
            content.innerHTML = `<span style="font-size: 13px; color: #c62828; font-weight: bold;">${cleanText}</span>`;
          } else {
            content.innerHTML =
              '<span style="font-size: 14px; color: var(--workday);">ç›®å‰ç„¡åœç­èª²è³‡è¨Š</span>';
          }
        } catch (e) {
          console.error(e);
          content.innerHTML =
            '<span style="font-size: 12px; color: var(--text-light);">é€£ç·šå¤±æ•—</span>';
        }
      }

      /**
       * é€éå¾Œç«¯ API æª¢æŸ¥é¢±é¢¨å‡è³‡è¨Š (Server Mode é©ç”¨)
       * (ç›®å‰æœªåœ¨ UI ä¸­ç›´æ¥å‘¼å«ï¼Œä¿ç•™ä¾›åƒè€ƒ)
       */
      async function checkTyphoon() {
        const content = document.getElementById('typhoonContent');
        content.innerHTML =
          '<span style="font-size: 14px; color: var(--text-light);">æŸ¥è©¢ä¸­...</span>';

        try {
          // æ³¨æ„ï¼šé€™è£¡å‡è¨­å¾Œç«¯ API å·²éƒ¨ç½²åœ¨ /api/holidays/realtime
          // è‹¥æ˜¯éœæ…‹é é¢ç›´æ¥é–‹å•Ÿï¼Œæ­¤åŠŸèƒ½æœƒå› ç‚ºè·¨åŸŸæˆ–æ‰¾ä¸åˆ° API è€Œå¤±æ•—
          const res = await fetch('/api/holidays/realtime');
          if (!res.ok) throw new Error('API Error');

          const data = await res.json();
          if (data && data.length > 0) {
            // æœ‰è³‡æ–™ï¼Œé¡¯ç¤ºç¬¬ä¸€ç­†çš„ summary
            const summary = data[0].summary['#text'];
            // ç°¡åŒ–é¡¯ç¤ºï¼šç§»é™¤ [åœç­åœèª²é€šçŸ¥] ç­‰å‰ç¶´ï¼Œåªé¡¯ç¤ºé‡é»
            let cleanText = summary
              .replace(/\[.*?\]/g, '')
              .replace(/è¡Œæ”¿é™¢äººäº‹è¡Œæ”¿ç¸½è™•.*/, '');
            content.innerHTML = `<span style="font-size: 13px; color: #c62828; font-weight: bold;">${cleanText}</span>`;
          } else {
            content.innerHTML =
              '<span style="font-size: 14px; color: var(--workday);">ç›®å‰ç„¡åœç­èª²è³‡è¨Š</span>';
          }
        } catch (e) {
          console.error(e);
          content.innerHTML =
            '<span style="font-size: 12px; color: var(--text-light);">ç„¡æ³•é€£ç·šè‡³ä¼ºæœå™¨</span>';
        }
      }

      /**
       * è¼‰å…¥ç‰¹å®šå¹´ä»½çš„è³‡æ–™
       * @param {number} year - ç›®æ¨™å¹´ä»½
       */
      async function loadYear(year) {
        if (holidayData[year]) return;
        try {
          const res = await fetch(`${DATA_PATH}/${year}.json?t=${new Date().getTime()}`);
          if (res.ok) holidayData[year] = await res.json();
        } catch (e) {
          console.warn(`ç„¡æ³•è¼‰å…¥ ${year} å¹´è³‡æ–™`);
        }
      }

      /**
       * æ›´æ–°è·³è½‰é€£çµ (å°‡ç•¶å‰é¸æ“‡çš„å¹´ä»½å¸¶å…¥ URL åƒæ•¸)
       */
      function updateLinks() {
        document.getElementById(
          'linkSimple'
        ).href = `simple.html?year=${currentYear}`;
        document.getElementById(
          'linkDetail'
        ).href = `detail.html?year=${currentYear}`;
      }

      /**
       * å–å¾—äº‹ä»¶é¡¯ç¤ºæ–‡å­—ï¼ˆå¥—ç”¨ç²¾ç°¡ç‰ˆé‚è¼¯ï¼‰
       * è² è²¬æ ¹æ“šå‡æ—¥é¡åˆ¥åˆ¤æ–·é¡¯ç¤ºåç¨±èˆ‡æ¨£å¼é¡å‹
       * 
       * @param {Object} item - å‡æ—¥è³‡æ–™ç‰©ä»¶
       * @param {boolean} isWeekend - æ˜¯å¦ç‚ºé€±æœ«
       * @returns {Object} { display: é¡¯ç¤ºæ–‡å­—, tooltip: æç¤ºæ–‡å­—, type: é¡å‹ }
       */
      function getEventDescription(item, isWeekend) {
        const isHoliday = item.holiday;
        const name = (item.name || '').trim();
        const desc = (item.description || '').trim();
        const category = (item.holidayCategory || '').trim();
        let display = '';
        let type = 'holiday'; // holiday, workday, special

        if (!isHoliday || category === 'è£œè¡Œä¸Šç­æ—¥') {
          // è£œç­æ—¥
          display = name ? `è£œç­(${name})` : 'è£œç­';
          type = 'workday';
        } else if (category === 'æ˜ŸæœŸå…­ã€æ˜ŸæœŸæ—¥') {
          // å‘¨ä¼‘
          if (name || desc) {
            display = name ? `å‘¨ä¼‘(${name})` : 'å‘¨ä¼‘(è©³)';
            type = 'weekend-special';
          } else {
            display = 'å‘¨ä¼‘';
            type = 'weekend';
          }
        } else if (category === 'èª¿æ•´æ”¾å‡æ—¥') {
          // èª¿æ•´æ”¾å‡ï¼ˆå¦‚å°å¹´å¤œï¼‰
          display = name || 'èª¿æ•´æ”¾å‡';
          type = 'adjusted';
        } else if (category === 'æ”¾å‡ä¹‹ç´€å¿µæ—¥åŠç¯€æ—¥') {
          // åœ‹å®šå‡æ—¥
          display = name || 'åœ‹å®šå‡æ—¥';
          type = 'holiday';
        } else if (name) {
          // å…¶ä»–æœ‰åç¨±çš„ç¯€æ—¥ï¼ˆå¦‚ç¯€æ°£ï¼‰
          display = name;
          type = 'special';
        } else {
          // å…¶ä»–è£œå‡
          display = 'è£œå‡';
          type = 'holiday';
        }

        const note = (item.note || '').trim();
        let tooltip = desc || `${category}${name ? ': ' + name : ''}`;
        if (note) {
            tooltip += ` (${note})`;
        }

        return {
          display,
          tooltip,
          type,
        };
      }

      /**
       * æ¸²æŸ“æœˆæ›†æ ¸å¿ƒé‚è¼¯
       * è¨ˆç®—æ¯æœˆå¤©æ•¸ã€è£œç™½ã€å¡«å…¥æ—¥æœŸèˆ‡äº‹ä»¶
       */
      function renderCalendar() {
        const firstDay = new Date(currentYear, currentMonth - 1, 1);
        const lastDay = new Date(currentYear, currentMonth, 0);
        // é€±æ—¥é–‹å§‹: getDay() é€±æ—¥=0, é€±ä¸€=1, ..., é€±å…­=6
        const startDay = firstDay.getDay();
        const daysInMonth = lastDay.getDate();
        const today = new Date();
        const todayStr = `${today.getFullYear()}/${String(
          today.getMonth() + 1
        ).padStart(2, '0')}/${String(today.getDate()).padStart(2, '0')}`;

        const yearData = holidayData[currentYear] || [];
        const dateMap = {};
        yearData.forEach((h) => {
          dateMap[h.date] = h;
        });

        let html = '';
        // ä¸Šæœˆè£œä½ (å¡«è£œç¬¬ä¸€é€±å‰é¢çš„ç©ºç™½)
        const prevMonth = new Date(currentYear, currentMonth - 1, 0);
        for (let i = startDay - 1; i >= 0; i--) {
          const d = prevMonth.getDate() - i;
          html += `<div class="day-cell other-month"><span class="day-number">${d}</span></div>`;
        }
        // ç•¶æœˆæ—¥æœŸç”Ÿæˆ
        for (let d = 1; d <= daysInMonth; d++) {
          // JSON è³‡æ–™æ—¥æœŸæ ¼å¼ç‚º YYYYMMDD (å¦‚ 20250127)
          const dateKey = `${currentYear}${String(currentMonth).padStart(
            2,
            '0'
          )}${String(d).padStart(2, '0')}`;
          // é¡¯ç¤ºç”¨æ ¼å¼ YYYY/MM/DD
          const dateDisplay = `${currentYear}/${String(currentMonth).padStart(
            2,
            '0'
          )}/${String(d).padStart(2, '0')}`;
          const dayOfWeek = new Date(currentYear, currentMonth - 1, d).getDay();
          const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
          const isToday = dateDisplay === todayStr;
          const h = dateMap[dateKey];

          let classes = 'day-cell';
          if (isWeekend) classes += ' weekend';
          if (isToday) classes += ' today';

          let events = '';
          if (h) {
            // å¥—ç”¨ç²¾ç°¡ç‰ˆé‚è¼¯ï¼šé¡¯ç¤ºå‘¨ä¼‘ã€è£œç­ç­‰è³‡è¨Š
            const eventInfo = getEventDescription(h, isWeekend);
            // æ ¹æ“šé¡å‹è¨­å®šä¸åŒçš„æ¨£å¼ class
            const eventClass = `event ${eventInfo.type}`;
            events = `<div class="${eventClass}" title="${eventInfo.tooltip}">${eventInfo.display}</div>`;
          }

          html += `<div class="${classes}"><span class="day-number">${d}</span><div class="day-events">${events}</div></div>`;
        }
        // è¨ˆç®—éœ€è¦å¹¾é€±ä»¥æ±ºå®šç¶²æ ¼é«˜åº¦
        const totalCells = startDay + daysInMonth;
        const weeksNeeded = Math.ceil(totalCells / 7);
        const targetCells = weeksNeeded * 7;
        // ä¸‹æœˆè£œä½ - å¡«æ»¿è©²é€±æ•¸æ‰€éœ€çš„æ ¼å­
        const remaining = targetCells - totalCells;
        for (let d = 1; d <= remaining; d++) {
          html += `<div class="day-cell other-month"><span class="day-number">${d}</span></div>`;
        }
        // è¨­å®šé€±æ•¸ class ä»¥èª¿æ•´æ ¼å­é«˜åº¦ (CSS Grid)
        calendarGrid.className = `calendar-grid weeks-${weeksNeeded}`;
        calendarGrid.innerHTML = html;
      }

      /**
       * åˆ‡æ›æœˆä»½
       * @param {number} delta - åˆ‡æ›é‡ (+1 æˆ– -1)
       */
      async function changeMonth(delta) {
        currentMonth += delta;
        if (currentMonth > 12) {
          currentMonth = 1;
          currentYear++;
        } else if (currentMonth < 1) {
          currentMonth = 12;
          currentYear--;
        }
        // è‹¥åˆ‡æ›å¾Œçš„å¹´ä»½ç„¡è³‡æ–™ï¼Œè·³è½‰è‡³é‚Šç•Œå¹´ä»½
        if (!availableYears.includes(String(currentYear))) {
          currentYear = parseInt(
            availableYears[delta > 0 ? 0 : availableYears.length - 1]
          );
          currentMonth = delta > 0 ? 1 : 12;
        }
        yearSelect.value = currentYear;
        monthSelect.value = currentMonth;
        updateLinks();
        await loadYear(currentYear);
        renderCalendar();
      }

      // äº‹ä»¶ç¶å®š
      document.getElementById('prevMonth').onclick = () => changeMonth(-1);
      document.getElementById('nextMonth').onclick = () => changeMonth(1);
      document.getElementById('todayBtn').onclick = async () => {
        const today = new Date();
        currentYear = today.getFullYear();
        currentMonth = today.getMonth() + 1;
        if (!availableYears.includes(String(currentYear))) {
          currentYear = parseInt(availableYears[0]);
        }
        yearSelect.value = currentYear;
        monthSelect.value = currentMonth;
        updateLinks();
        await loadYear(currentYear);
        renderCalendar();
      };
      yearSelect.onchange = async () => {
        currentYear = parseInt(yearSelect.value);
        updateLinks();
        await loadYear(currentYear);
        renderCalendar();
      };
      monthSelect.onchange = () => {
        currentMonth = parseInt(monthSelect.value);
        renderCalendar();
      };

      // å•Ÿå‹•ç¨‹å¼
      init();
    </script>
  </body>
  <!-- GitHub Corner åœ–ç¤º -->
  <a
    href="https://github.com/vancetang/spring-boot-lab"
    class="github-corner"
    aria-label="View source on GitHub"
    ><svg
      width="80"
      height="80"
      viewBox="0 0 250 250"
      style="
        fill: #70b7fd;
        color: #fff;
        position: absolute;
        top: 0;
        border: 0;
        right: 0;
      "
      aria-hidden="true"
    >
      <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z" />
      <path
        d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
        fill="currentColor"
        style="transform-origin: 130px 106px"
        class="octo-arm"
      />
      <path
        d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
        fill="currentColor"
        class="octo-body"
      /></svg></a
  ><style>
    .github-corner:hover .octo-arm {
      animation: octocat-wave 560ms ease-in-out;
    }
    @keyframes octocat-wave {
      0%,
      100% {
        transform: rotate(0);
      }
      20%,
      60% {
        transform: rotate(-25deg);
      }
      40%,
      80% {
        transform: rotate(10deg);
      }
    }
    @media (max-width: 500px) {
      .github-corner:hover .octo-arm {
        animation: none;
      }
      .github-corner .octo-arm {
        animation: octocat-wave 560ms ease-in-out;
      }
    }
  </style>
</html>
