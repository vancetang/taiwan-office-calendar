name: Update Holiday Data

on:
  # å…è¨±åœ¨ GitHub Actions ä»‹é¢æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:

  # æ’ç¨‹åŸ·è¡Œï¼šæ¯æœˆ 15 è™Ÿ 00:00 UTC (å°ç£æ™‚é–“ 08:00)
  schedule:
    - cron: "0 0 15 * *"

# çµ¦äºˆ workflow å¯«å…¥å„²å­˜åº«çš„æ¬Šé™ (ç‚ºäº† git push)
permissions:
  contents: write

jobs:
  fetch-and-update:
    runs-on: ubuntu-latest

    #åœ¨æ­¤è¨­å®š Git Committer çš„èº«åˆ†
    env:
      GIT_USER_NAME: "github-actions[bot]"
      GIT_USER_EMAIL: "github-actions[bot]@users.noreply.github.com"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: "maven"

      - name: Run Fetch Data Job
        # åŸ·è¡Œ Task Modeï¼Œä¸¦æŠ‘åˆ¶éå¤šè¼¸å‡º (-q)
        run: mvn spring-boot:run "-Dspring-boot.run.arguments=--job=fetch" -q

      - name: Check for changes and Commit
        run: |
          # æª¢æŸ¥ src/main/resources/static/opendata/holiday/ ç›®éŒ„ä¸‹æ˜¯å¦æœ‰è®Šæ›´
          if [ -z "$(git status --porcelain src/main/resources/static/opendata/holiday/)" ]; then
            echo "âœ¨ æœªåµæ¸¬åˆ°è®Šæ›´ã€‚è·³éæäº¤ã€‚"
            exit 0
          fi

          echo "ğŸ“ åµæ¸¬åˆ°è®Šæ›´ã€‚æ­£åœ¨è¨­å®š Git..."
          git config --global user.name "${{ env.GIT_USER_NAME }}"
          git config --global user.email "${{ env.GIT_USER_EMAIL }}"

          echo "â• æ­£åœ¨æš«å­˜æª”æ¡ˆ..."
          git add src/main/resources/static/opendata/holiday/*.json

          echo "ğŸ’¾ æ­£åœ¨æäº¤..."
          # å–å¾—ç•¶å‰æ—¥æœŸ
          TODAY=$(date +'%Y-%m-%d')
          git commit -m "chore(data): auto-update holiday data on $TODAY"

          echo "â¬†ï¸ æ­£åœ¨æ¨é€è‡³å„²å­˜åº«..."
          git push
          echo "ğŸš€ è®Šæ›´å·²æˆåŠŸæ¨é€"
